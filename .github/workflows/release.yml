name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get domain from secrets
        id: get_domain
        run: |
          DOMAIN="${{ secrets.SERVER_DOMAIN }}"
          if [ -z "$DOMAIN" ]; then
            DOMAIN="your_domain.com"
            echo "âš ï¸ SERVER_DOMAIN secret not set, using placeholder"
          fi
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Domain: $DOMAIN"

      - name: Create release archive
        run: |
          mkdir -p release
          cp v2ray-server-setup.sh release/
          cp v2ray-manage.sh release/
          cp README.md release/
          cp ENV.md release/
          if [ -f .env.example ]; then
            cp .env.example release/
          fi
          
          tar -czf v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz -C release .
          zip -r v2ray-setup-${{ steps.get_version.outputs.version }}.zip release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz
            v2ray-setup-${{ steps.get_version.outputs.version }}.zip
          body: |
            ## V2Ray æœåŠ¡å™¨å®‰è£…è„šæœ¬ ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `v2ray-server-setup.sh` - å®‰è£…è„šæœ¬
            - `v2ray-manage.sh` - ç®¡ç†è„šæœ¬
            - `README.md` - å®Œæ•´æ–‡æ¡£
            - `ENV.md` - ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£
            - `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            ```bash
            # è§£å‹æ–‡ä»¶
            tar -xzf v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz
            cd release
            
            # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            cp .env.example .env
            
            # è®¾ç½®åŸŸåï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
            echo "DOMAIN=${{ steps.get_domain.outputs.domain }}" >> .env
            
            # æ‰§è¡Œå®‰è£…
            sudo bash v2ray-server-setup.sh
            ```
            
            **æç¤º**ï¼šå¦‚æœè®¾ç½®äº† `SERVER_DOMAIN` Secretï¼Œä¸Šè¿°å‘½ä»¤ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥åŸŸåã€‚å¦åˆ™è¯·æ‰‹åŠ¨ç¼–è¾‘ `.env` æ–‡ä»¶è®¾ç½® `DOMAIN=your_domain.com`
            
            ### ğŸ“š æ–‡æ¡£
            
            è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹ [README.md](README.md)
          draft: false
          prerelease: false

