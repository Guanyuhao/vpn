name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create release archive
        run: |
          echo "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."
          # ç¡®ä¿ä¸ä¼šæ‰“åŒ…æ•æ„Ÿæ–‡ä»¶
          if [ -f .env ]; then
            echo "âš ï¸ è­¦å‘Š: .env æ–‡ä»¶å­˜åœ¨ï¼Œä½†ä¸ä¼šè¢«åŒ…å«åœ¨ Release ä¸­ï¼ˆå·²æ’é™¤ï¼‰"
          fi
          
          echo "åˆ›å»ºå‘å¸ƒåŒ…..."
          mkdir -p release
          
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶
          cp v2ray-server-setup.sh release/
          cp v2ray-manage.sh release/
          
          # å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
          cp README.md release/
          cp ENV.md release/
          
          # åªå¤åˆ¶ .env.exampleï¼ˆæ¨¡æ¿æ–‡ä»¶ï¼Œä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
          if [ -f .env.example ]; then
            cp .env.example release/
            echo "âœ“ å·²åŒ…å« .env.exampleï¼ˆæ¨¡æ¿æ–‡ä»¶ï¼‰"
          fi
          
          # æ˜¾å¼æ’é™¤æ•æ„Ÿæ–‡ä»¶
          echo "æ£€æŸ¥æ‰“åŒ…å†…å®¹..."
          ls -lh release/
          
          # ç¡®è®¤æ²¡æœ‰æ•æ„Ÿæ–‡ä»¶
          if [ -f release/.env ]; then
            echo "âŒ é”™è¯¯: release/.env ä¸åº”å­˜åœ¨ï¼"
            rm -f release/.env
            exit 1
          fi
          
          echo "âœ“ å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œåˆ›å»ºå‹ç¼©åŒ…..."
          tar -czf v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz -C release .
          zip -r v2ray-setup-${{ steps.get_version.outputs.version }}.zip release/
          
          echo "âœ“ æ‰“åŒ…å®Œæˆ"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz
            v2ray-setup-${{ steps.get_version.outputs.version }}.zip
          body: |
            ## V2Ray æœåŠ¡å™¨å®‰è£…è„šæœ¬ ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `v2ray-server-setup.sh` - å®‰è£…è„šæœ¬
            - `v2ray-manage.sh` - ç®¡ç†è„šæœ¬
            - `README.md` - å®Œæ•´æ–‡æ¡£
            - `ENV.md` - ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£
            - `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            ```bash
            # è§£å‹æ–‡ä»¶
            tar -xzf v2ray-setup-${{ steps.get_version.outputs.version }}.tar.gz
            cd release
            
            # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            cp .env.example .env
            nano .env  # è®¾ç½® DOMAIN=your_domain.com
            
            # æ‰§è¡Œå®‰è£…
            sudo bash v2ray-server-setup.sh
            ```
            
            ### ğŸ“š æ–‡æ¡£
            
            è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹ [README.md](README.md)
          draft: false
          prerelease: false

